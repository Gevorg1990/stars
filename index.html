<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js Comment System</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
</head>
<body>
<div id="app">
    <h1>Comment System</h1>
    <form @submit.prevent="addComment">
        <div
                class="editable-div"
                contenteditable="true"
                ref="editableDiv"
                placeholder="Type your comment here..."
        ></div>
        <div class="emoji-picker">
            <button @click="togglePicker" type="button">
                <svg viewBox="0 0 12 13" width="20" height="20" fill="currentColor" class="x19dipnz x1lliihq x1tzjh5l x1k90msu x2h7rmj x1qfuztq" style="--color: var(--primary-icon);"><g fill-rule="evenodd" transform="translate(-450 -1073)"><path d="M458.508 1078.5a1 1 0 1 1-.015-2.002 1 1 0 0 1 .015 2.002m-.037 1.668c-.324.91-1.273 1.832-2.46 1.832h-.002c-1.2 0-2.157-.922-2.48-1.832a.5.5 0 1 1 .942-.335c.204.573.835 1.167 1.538 1.167h.001c.692 0 1.315-.593 1.519-1.168a.5.5 0 0 1 .942.335m-5.971-2.667a1 1 0 1 1 2 0 1 1 0 0 1-2 0m3.5-3.5a5.506 5.506 0 0 0-5.5 5.5c0 3.033 2.467 5.5 5.5 5.5s5.5-2.467 5.5-5.5-2.467-5.5-5.5-5.5"></path></g></svg>
            </button>
            <div v-if="showPicker" class="emoji-list">
                <div
                        v-for="emoji in emojis"
                        :key="emoji.src"
                        @click="selectEmoji(emoji)"
                        class="emoji-item"
                >
                    <img :src="emoji.src" :alt="emoji.alt" />
                </div>
            </div>
        </div>
        <button type="submit">Add Comment</button>
    </form>



    <div v-cloak>
        <h2>Global Rating:</h2>
        <div class="stars">
            <span v-for="star in 5" :key="star"
                  class="star"
                  :class="{ filled: star <= tempRating, empty: star > tempRating }"
                  @mouseover="hoverRating(star)"
                  @mouseleave="resetRating"
                  @click="setRating(star)">
                ★
            </span>
        </div>
        <p>Total Comments: {{ commentCount }}</p>
        <p>Average Rating: {{ averageRating }}</p>
    </div>

    <div>
        <div v-for="comment in comments" :key="comment.id">
            <div v-html="comment.text"></div>
            <button v-if="comment.userId === frontUserId" @click="deleteComment(comment.id)">Delete</button>
        </div>
    </div>

    <div
            class="Stars"
            :style="{ '--rating': averageRating }"
            aria-label="Rating of this product is {{ averageRating }} out of 5."
    >
    </div>
</div>

<script>
    // Helper functions for cookie management
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = `expires=${date.toUTCString()};`;
        }
        document.cookie = `${name}=${value}; ${expires}path=/`;
    }

    const app = Vue.createApp({
        data() {
            return {
                globalRating: 5,
                tempRating: 5,
                comments: [],
                commentCount: 0,
                averageRating: 0,
                frontUserId: getCookie('frontUserId') || uuid.v4(),
                showPicker: false,
                emojis: [
                    { src: 'https://static.xx.fbcdn.net/images/emoji.php/v9/t3a/1/30/1f60d.png', alt: '😍' },
                    { src: 'https://static.xx.fbcdn.net/images/emoji.php/v9/t90/1/30/1f929.png', alt: '🤩' },
                    { src: 'https://static.xx.fbcdn.net/images/emoji.php/v9/ta5/1/30/1f973.png', alt: '🥳' },
                    { src: 'https://static.xx.fbcdn.net/images/emoji.php/v9/t3a/1/30/1f60d.png', alt: '🥺' },
                    // Add more emojis as needed
                ],
            };
        },
        methods: {
            async fetchComments() {
                try {
                    const response = await fetch('https://scaling-funicular-rwpwjrw9q97hvwq-3000.app.github.dev/comments');
                    if (!response.ok) throw new Error('Failed to fetch comments');
                    const data = await response.json();
                    this.comments = data.comments;
                    this.globalRating = data.globalRating || 1;
                    this.tempRating = this.globalRating;
                    this.commentCount = data.comments.length;
                    this.averageRating = data.averageRating || 0;
                } catch (error) {
                    console.error('Error fetching comments:', error);
                }
            },
            async addComment() {
                const commentText = this.$refs.editableDiv.innerHTML.trim();
                if (commentText) {
                    try {
                        const response = await fetch('https://scaling-funicular-rwpwjrw9q97hvwq-3000.app.github.dev/comments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: commentText,
                                rating: this.globalRating,
                                userId: this.frontUserId
                            })
                        });
                        if (!response.ok) throw new Error('Failed to add comment');
                        this.$refs.editableDiv.innerHTML = ''; // Clear the div after adding comment
                        await this.fetchComments();
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                }
            },
            async deleteComment(commentId) {
                if (confirm('Are you sure you want to delete this comment?')) {
                    try {
                        const response = await fetch(`https://scaling-funicular-rwpwjrw9q97hvwq-3000.app.github.dev/comments/${commentId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ userId: this.frontUserId })
                        });
                        if (!response.ok) throw new Error('Failed to delete comment');
                        await this.fetchComments();
                    } catch (error) {
                        console.error('Error deleting comment:', error);
                    }
                }
            },
            async saveGlobalRating() {
                try {
                    const response = await fetch('https://scaling-funicular-rwpwjrw9q97hvwq-3000.app.github.dev/global-rating', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ rating: this.globalRating })
                    });
                    if (!response.ok) throw new Error('Failed to save global rating');
                    await this.fetchComments();
                } catch (error) {
                    console.error('Error saving global rating:', error);
                }
            },
            setRating(star) {
                this.globalRating = star;
                this.tempRating = 5;
                this.saveGlobalRating();
            },
            hoverRating(star) {
                this.tempRating = star;
            },
            resetRating() {
                this.tempRating = this.globalRating;
            },

            // emoji
            togglePicker() {
                this.showPicker = !this.showPicker;
            },
            selectEmoji(emoji) {
                const editableDiv = this.$refs.editableDiv;

                // Create a new range and selection
                const range = document.createRange();
                const sel = window.getSelection();

                if (sel.rangeCount > 0) {
                    range.setStart(sel.getRangeAt(0).startContainer, sel.getRangeAt(0).startOffset);
                    range.collapse(true);
                } else {
                    range.setStart(editableDiv, 0);
                }

                // Insert emoji
                const imgTag = `<img style="vertical-align: middle; width: 20px; margin: 0 2px;" src="${emoji.src}" alt="${emoji.alt}" />`;
                range.deleteContents(); // Delete the current selection if any
                const emojiNode = new DOMParser().parseFromString(imgTag, 'text/html').body.firstChild;
                range.insertNode(emojiNode);

                // Move the cursor to the end of the inserted emoji
                range.setStartAfter(emojiNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);

                // Focus back on the editable div
                editableDiv.focus();

                this.showPicker = false; // Hide picker after selection
            }
            ,
            //  End emoji
        },
        mounted() {
            if (!getCookie('frontUserId')) {
                setCookie('frontUserId', this.frontUserId, 365);
            }
            this.fetchComments();
        }
    });

    app.mount('#app');
</script>
</body>
</html>
