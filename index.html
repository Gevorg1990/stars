<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js Comment System</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* Your existing styles */
    </style>
</head>
<body>
<div id="app">
    <h1>Comment System</h1>
    <form @submit.prevent="addComment">
        <input type="text" v-model="newComment" placeholder="Enter your comment" required>
        <button type="submit">Add Comment</button>
    </form>

    <!-- Global Rating Display -->
    <div>
        <h2>Global Rating:</h2>
        <div class="stars">
                <span v-for="star in 5" :key="star"
                      class="star"
                      :class="{ filled: star <= tempRating, empty: star > tempRating }"
                      @mouseover="hoverRating(star)"
                      @mouseleave="resetRating"
                      @click="setRating(star)">
                    â˜…
                </span>
        </div>
        <p>Total Comments: {{ commentCount }}</p>
        <p>Average Rating: {{ averageRating }}</p>
    </div>

    <div>
        <div v-for="(comment, index) in comments" :key="index">
            {{ comment.text }}
            <!-- Only show delete button if comment belongs to the current user -->
            <button v-if="comment.userId === userId" @click="deleteComment(index)">Delete</button>
        </div>
    </div>

    <div class="Stars" :style="{ '--rating': averageRating }" aria-label="Rating of this product is 2.3 out of 5.">
        <!-- Star icons or other content here -->
    </div>
</div>

<script>
    const app = Vue.createApp({
        data() {
            return {
                userId: null, // Initialize userId
                newComment: '',
                globalRating: 3,
                tempRating: 3,
                comments: [],
                commentCount: 0,
                averageRating: 0 // Average rating
            };
        },
        methods: {
            // Extract userId from JWT token
            extractUserIdFromToken() {
                const token = localStorage.getItem('jwtToken'); // Retrieve token from localStorage
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1])); // Decode JWT payload
                        this.userId = payload.userId; // Set userId from token payload
                    } catch (e) {
                        console.error('Error decoding JWT token:', e);
                    }
                }
            },
            // async fetchComments() {
            //     try {
            //         const response = await fetch('https://jubilant-bassoon-p9p9xg9vx5437475-3000.app.github.dev/comments');
            //         if (!response.ok) throw new Error('Failed to fetch comments');
            //         const data = await response.json();
            //         this.comments = data.comments;
            //         this.globalRating = data.globalRating || 1;
            //         this.tempRating = this.globalRating;
            //         this.commentCount = data.comments.length;
            //         this.averageRating = data.averageRating || 0; // Update averageRating
            //         console.log(data);
            //     } catch (error) {
            //         console.error('Error fetching comments:', error);
            //     }
            // },
            async fetchComments() {
                try {
                    const response = await fetch('https://jubilant-bassoon-p9p9xg9vx5437475-3000.app.github.dev/comments', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` // Include JWT token if required
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    this.comments = data.comments;
                    this.globalRating = data.globalRating || 1;
                    this.tempRating = this.globalRating;
                    this.commentCount = data.comments.length;
                    this.averageRating = data.averageRating || 0; // Update averageRating
                    console.log(data);
                } catch (error) {
                    console.error('Error fetching comments:', error);
                    alert(`Failed to fetch comments: ${error.message}`);
                }
            },
            async addComment() {
                if (this.newComment.trim()) {
                    try {
                        const response = await fetch('https://jubilant-bassoon-p9p9xg9vx5437475-3000.app.github.dev/comments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` // Send JWT token in Authorization header
                            },
                            body: JSON.stringify({
                                text: this.newComment.trim(),
                                rating: this.globalRating
                            })
                        });
                        if (!response.ok) throw new Error('Failed to add comment');
                        this.newComment = '';
                        await this.fetchComments();
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                }
            },
            async deleteComment(index) {
                try {
                    const response = await fetch(`https://jubilant-bassoon-p9p9xg9vx5437475-3000.app.github.dev/comments/${index}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` // Send JWT token in Authorization header
                        }
                    });
                    if (!response.ok) throw new Error('Failed to delete comment');
                    await this.fetchComments();
                } catch (error) {
                    console.error('Error deleting comment:', error);
                }
            },
            async saveGlobalRating() {
                try {
                    const response = await fetch('https://jubilant-bassoon-p9p9xg9vx5437475-3000.app.github.dev/global-rating', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` // Send JWT token in Authorization header
                        },
                        body: JSON.stringify({ rating: this.globalRating })
                    });
                    if (!response.ok) throw new Error('Failed to save global rating');
                    await this.fetchComments();
                } catch (error) {
                    console.error('Error saving global rating:', error);
                }
            },
            setRating(star) {
                this.globalRating = star;
                this.saveGlobalRating(); // Save rating to server
            },
            hoverRating(star) {
                this.tempRating = star;
            },
            resetRating() {
                this.tempRating = this.globalRating;
            }
        },
        mounted() {
            this.extractUserIdFromToken(); // Extract userId from token on mount
            this.fetchComments();
        }
    });

    app.mount('#app');
</script>
</body>
</html>
