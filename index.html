<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js Comment System</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
</head>
<body>
<div id="app">
    <h1>Comment System</h1>
    <form @submit.prevent="addComment">
        <input type="text" v-model="newComment" placeholder="Enter your comment" required>
        <button type="submit">Add Comment</button>
    </form>

    <!-- Global Rating Display -->
    <div v-cloak>
        <h2>Global Rating:</h2>
        <div class="stars">
            <span v-for="star in 5" :key="star"
                  class="star"
                  :class="{ filled: star <= tempRating, empty: star > tempRating }"
                  @mouseover="hoverRating(star)"
                  @mouseleave="resetRating"
                  @click="setRating(star)">
                â˜…
            </span>
        </div>
        <p>Total Comments: {{ commentCount }}</p>
        <p>Average Rating: {{ averageRating }}</p>
    </div>

    <div>
        <div v-for="comment in comments" :key="comment.id">
            {{ comment.text }}
            <button v-if="comment.userId === frontUserId" @click="deleteComment(comment.id)">Delete</button>
        </div>
    </div>

    <div
        class="Stars"
        :style="{ '--rating': averageRating }"
        aria-label="Rating of this product is 2.3 out of 5."
    >

    </div>
</div>

<script>
    // Helper functions for cookie management
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = `expires=${date.toUTCString()};`;
        }
        document.cookie = `${name}=${value}; ${expires}path=/`;
    }

    const app = Vue.createApp({
        data() {
            return {
                newComment: '',
                globalRating: 5, // Default rating value
                tempRating: 5, // Default temp rating value
                comments: [],
                commentCount: 0,
                averageRating: 0, // Average rating
                frontUserId: getCookie('frontUserId') || uuid.v4() // Get user ID from cookies or generate new
            };
        },
        methods: {
            async fetchComments() {
                try {
                    const response = await fetch('https://laughing-space-succotash-g676g569g953wwr5-3000.app.github.dev/comments'); // Adjust URL for local development
                    if (!response.ok) throw new Error('Failed to fetch comments');
                    const data = await response.json();
                    console.log('Fetched comments:', data); // Log the comments to check if userId is present
                    this.comments = data.comments;
                    this.globalRating = data.globalRating || 1;
                    this.tempRating = this.globalRating; // Sync tempRating with globalRating
                    this.commentCount = data.comments.length;
                    this.averageRating = data.averageRating || 0; // Update averageRating
                } catch (error) {
                    console.error('Error fetching comments:', error);
                }
            },
            async addComment() {
                if (this.newComment.trim()) {
                    try {
                        const response = await fetch('https://laughing-space-succotash-g676g569g953wwr5-3000.app.github.dev/comments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: this.newComment.trim(),
                                rating: this.globalRating,
                                userId: this.frontUserId // Include the current user's ID
                            })
                        });
                        if (!response.ok) throw new Error('Failed to add comment');
                        this.newComment = '';
                        await this.fetchComments();
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                }
            },
            async deleteComment(commentId) {
                if (confirm('Are you sure you want to delete this comment?')) {
                    try {
                        const response = await fetch(`https://laughing-space-succotash-g676g569g953wwr5-3000.app.github.dev/comments/${commentId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ userId: this.frontUserId }) // Include userId in delete request
                        });
                        if (!response.ok) throw new Error('Failed to delete comment');
                        await this.fetchComments();
                    } catch (error) {
                        console.error('Error deleting comment:', error);
                    }
                }
            },
            async saveGlobalRating() {
                try {
                    const response = await fetch('https://laughing-space-succotash-g676g569g953wwr5-3000.app.github.dev/global-rating', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ rating: this.globalRating })
                    });
                    if (!response.ok) throw new Error('Failed to save global rating');
                    await this.fetchComments();
                } catch (error) {
                    console.error('Error saving global rating:', error);
                }
            },
            setRating(star) {
                this.globalRating = star;
                this.tempRating = 5; // Ensure tempRating reflects the new rating
                this.saveGlobalRating(); // Save rating to server
            },
            hoverRating(star) {
                this.tempRating = star;
            },
            resetRating() {
                this.tempRating = this.globalRating;
            }
        },
        mounted() {
            // Save frontUserId to cookies if not already set
            if (!getCookie('frontUserId')) {
                setCookie('frontUserId', this.frontUserId, 365);
            }
            this.fetchComments();
        }
    });

    app.mount('#app');
</script>
</body>
</html>
